name: Test Recipe Robot

on:
  push:
    branches: [ main, dev, test ]
  pull_request:
    branches: [ main, dev, test ]

jobs:
  test:
    name: Test on macOS ${{ matrix.macos-version }}
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: "15"
            runner: macos-15
          - macos-version: "14"
            runner: macos-14

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: System Information
      run: |
        echo "üñ•Ô∏è  Testing Recipe Robot on macOS ${{ matrix.macos-version }}"
        echo "Runner: ${{ matrix.runner }}"
        echo "macOS version: $(sw_vers -productVersion)"
        echo "Build version: $(sw_vers -buildVersion)"
        echo "Xcode version: $(xcodebuild -version)"
        echo "Available SDKs:"
        xcodebuild -showsdks | grep macosx

    - name: Install Carthage
      run: |
        if ! command -v carthage &> /dev/null; then
          echo "üì¶ Installing Carthage via Homebrew..."
          brew install carthage
        else
          echo "üì¶ Carthage already available: $(carthage version)"
        fi

    - name: Bootstrap Dependencies
      run: |
        cd app
        echo "üîß Bootstrapping Carthage dependencies..."
        carthage bootstrap --platform macOS --use-xcframeworks --cache-builds
        echo "‚úÖ Dependencies installed successfully"

    - name: Setup Build Environment
      run: |
        # Create a temporary keychain to avoid keychain access issues
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings build.keychain
        echo "üîê Temporary keychain created for build"

        # Create a dummy codesign script
        echo '#!/bin/bash' | sudo tee /usr/local/bin/codesign_dummy > /dev/null
        echo 'echo "Dummy codesign called with args: $@"' | sudo tee -a /usr/local/bin/codesign_dummy > /dev/null
        echo 'exit 0' | sudo tee -a /usr/local/bin/codesign_dummy > /dev/null
        sudo chmod +x /usr/local/bin/codesign_dummy

        # Backup original codesign and replace with dummy
        sudo cp /usr/bin/codesign /usr/bin/codesign_original
        sudo cp /usr/local/bin/codesign_dummy /usr/bin/codesign

    - name: Build and Test
      env:
        SKIP_SIGNING: "YES"
        CI: "true"
      run: |
        cd app
        echo "üß™ Building and testing Recipe Robot..."

        # Try building and testing in one command first
        xcodebuild test \
          -workspace "Recipe Robot.xcworkspace" \
          -scheme "Recipe Robot" \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData \
          -quiet \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          CODE_SIGN_ENTITLEMENTS="" \
          CODE_SIGN_STYLE=Manual \
          EXPANDED_CODE_SIGN_IDENTITY_NAME="-" \
          SKIP_INSTALL=YES

    - name: Test Results Summary
      if: always()
      run: |
        cd app
        echo "üìä Test Results Summary for macOS ${{ matrix.macos-version }}:"
        if [ -d "DerivedData/Logs/Test" ]; then
          echo "‚úÖ Test logs generated successfully"
          find DerivedData/Logs/Test -name "*.xcresult" | head -5
        else
          echo "‚ùå No test logs found"
          echo "Checking for build logs..."
          find DerivedData/Logs -type f | head -10 || echo "No logs found"
        fi

    - name: Cleanup
      if: always()
      run: |
        # Restore original codesign
        sudo cp /usr/bin/codesign_original /usr/bin/codesign || true
        # Clean up temporary keychain
        security delete-keychain build.keychain || true
        echo "üßπ Cleanup completed"
