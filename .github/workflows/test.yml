name: Test Recipe Robot

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    name: Test on macOS ${{ matrix.macos-version }}
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: "15"
            runner: macos-15
          - macos-version: "14"
            runner: macos-14
          - macos-version: "13"
            runner: macos-13

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: System Information
      run: |
        echo "ğŸ–¥ï¸  Testing Recipe Robot on macOS ${{ matrix.macos-version }}"
        echo "Runner: ${{ matrix.runner }}"
        echo "macOS version: $(sw_vers -productVersion)"
        echo "Build version: $(sw_vers -buildVersion)"
        echo "Xcode version: $(xcodebuild -version)"
        echo "Available SDKs:"
        xcodebuild -showsdks | grep macosx

    - name: Install Carthage
      run: |
        if ! command -v carthage &> /dev/null; then
          echo "ğŸ“¦ Installing Carthage via Homebrew..."
          brew install carthage
        else
          echo "ğŸ“¦ Carthage already available: $(carthage version)"
        fi

    - name: Bootstrap Dependencies
      run: |
        cd app
        echo "ğŸ”§ Bootstrapping Carthage dependencies..."
        carthage bootstrap --platform macOS --use-xcframeworks --cache-builds
        echo "âœ… Dependencies installed successfully"

    - name: Setup Build Environment
      run: |
        # Create a temporary keychain to avoid keychain access issues
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings build.keychain
        echo "ğŸ” Temporary keychain created for build"

    - name: Build and Test
      run: |
        cd app
        echo "ğŸ§ª Building and testing Recipe Robot..."
        xcodebuild test \
          -workspace "Recipe Robot.xcworkspace" \
          -scheme "Recipe Robot" \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData \
          -quiet \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          CODE_SIGN_ENTITLEMENTS="" \
          CODE_SIGN_STYLE=Manual

    - name: Test Results Summary
      if: always()
      run: |
        cd app
        echo "ğŸ“Š Test Results Summary for macOS ${{ matrix.macos-version }}:"
        if [ -d "DerivedData/Logs/Test" ]; then
          echo "âœ… Test logs generated successfully"
          find DerivedData/Logs/Test -name "*.xcresult" | head -5
        else
          echo "âŒ No test logs found"
          echo "Checking for build logs..."
          find DerivedData/Logs -type f | head -10 || echo "No logs found"
        fi

    - name: Cleanup
      if: always()
      run: |
        # Clean up temporary keychain
        security delete-keychain build.keychain || true
        echo "ğŸ§¹ Cleanup completed"
